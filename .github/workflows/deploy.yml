name: Deploy To Ubuntu

on:
  workflow_run:
    workflows:
      - Docker Publish
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy via SSH
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') }}
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        env:
          GHCR_USERNAME: ${{ vars.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        with:
          host: ${{ vars.DEPLOY_HOST }}
          username: ${{ vars.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ vars.DEPLOY_PORT != '' && vars.DEPLOY_PORT || '22' }}
          script_stop: true
          envs: GHCR_USERNAME,GHCR_TOKEN
          command_timeout: 20m
          script: |
            set -euo pipefail

            APP_DIR="/home/ubuntu/code/go_code/c2c_monitor"
            COMPOSE_DIR="$APP_DIR/deploy/compose"

            cd "$APP_DIR"
            git pull --rebase --autostash origin main

            # Stop legacy non-container processes to avoid port conflicts.
            pkill -x c2c_monitor 2>/dev/null || true
            pkill -f "python3 frontend/dev_server.py" 2>/dev/null || true

            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USERNAME" --password-stdin

            if docker compose version >/dev/null 2>&1; then
              COMPOSE="docker compose"
            elif command -v docker-compose >/dev/null 2>&1; then
              COMPOSE="docker-compose"
            else
              echo "docker compose is not installed on server"
              exit 1
            fi

            cd "$COMPOSE_DIR"
            $COMPOSE pull
            $COMPOSE up -d --remove-orphans
            $COMPOSE ps

            curl -fsS http://localhost:8080 >/dev/null
            curl -fsS http://localhost:8080/api/config >/dev/null
